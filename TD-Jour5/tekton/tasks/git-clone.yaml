# Task: Git Clone
# Clone un repository Git dans un workspace partagé
# Réutilisable par tous les pipelines
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-clone
  namespace: tekton-pipelines
  labels:
    app.kubernetes.io/part-of: tekton-tasks
  annotations:
    tekton.dev/displayName: "Git Clone"
    tekton.dev/categories: "Git"
    tekton.dev/tags: "git, clone, source"
spec:
  description: |
    Clone un repository Git.
    Le code est placé dans le workspace 'output' pour être utilisé par les Tasks suivantes.

  params:
    - name: url
      description: URL du repository Git
      type: string
    - name: revision
      description: Branch, tag ou commit à checkout
      type: string
      default: main
    - name: submodules
      description: Initialiser les submodules
      type: string
      default: "false"

  workspaces:
    - name: output
      description: Workspace où le code sera cloné

  results:
    - name: commit
      description: SHA du commit cloné
    - name: url
      description: URL du repository

  steps:
    - name: clone
      image: alpine/git:latest
      workingDir: $(workspaces.output.path)
      script: |
        #!/bin/sh
        set -e

        echo "Cloning $(params.url) at revision $(params.revision)"

        # Clone le repo
        git clone --depth 1 --branch $(params.revision) $(params.url) .

        # Optionnel: submodules
        if [ "$(params.submodules)" = "true" ]; then
          git submodule update --init --recursive
        fi

        # Sauvegarder les résultats
        git rev-parse HEAD | tr -d '\n' > $(results.commit.path)
        echo -n "$(params.url)" > $(results.url.path)

        echo "Clone complete. Commit: $(cat $(results.commit.path))"
