# ===========================================
# Grafana Service
# ===========================================
# Expose Grafana UI
#
# TYPE : ClusterIP (interne uniquement)
# - Accessible via port-forward pour le développement
# - Ou via Ingress pour la production
#
# PORTS :
# - 3000 : Grafana UI
#
# ACCÈS :
#   kubectl port-forward -n monitoring svc/grafana-service 3000:3000
#   http://localhost:3000
#   Login : admin / greenwatt2025
#
# ===========================================

apiVersion: v1
kind: Service
metadata:
  name: grafana-service
  namespace: monitoring
  labels:
    app: grafana
    component: monitoring
spec:
  type: ClusterIP  # Interne uniquement

  selector:
    app: grafana

  ports:
  - name: http
    protocol: TCP
    port: 3000
    targetPort: 3000

---
# ===========================================
# OPTION : NodePort pour accès externe (Minikube)
# ===========================================
# Si vous voulez accéder à Grafana sans port-forward :
#
# apiVersion: v1
# kind: Service
# metadata:
#   name: grafana-nodeport
#   namespace: monitoring
# spec:
#   type: NodePort
#   selector:
#     app: grafana
#   ports:
#   - name: http
#     protocol: TCP
#     port: 3000
#     targetPort: 3000
#     nodePort: 30300  # Accessible via http://<minikube-ip>:30300
#
# Commande : minikube service grafana-nodeport -n monitoring

---
# ===========================================
# OPTION : Ingress pour accès externe (Production)
# ===========================================
# Expose Grafana via un sous-domaine
#
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: grafana-ingress
#   namespace: monitoring
#   annotations:
#     nginx.ingress.kubernetes.io/rewrite-target: /
#     # TLS/SSL
#     cert-manager.io/cluster-issuer: "letsencrypt-prod"
# spec:
#   ingressClassName: nginx
#   tls:
#   - hosts:
#     - grafana.greenwatt.local
#     secretName: grafana-tls
#   rules:
#   - host: grafana.greenwatt.local
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: grafana-service
#             port:
#               number: 3000
#
# Ajouter au /etc/hosts :
# echo "$(minikube ip) grafana.greenwatt.local" | sudo tee -a /etc/hosts

---
# ===========================================
# OPTION : Unified Ingress (Grafana + Prometheus)
# ===========================================
# Expose Grafana ET Prometheus via un seul Ingress
#
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: monitoring-ingress
#   namespace: monitoring
#   annotations:
#     nginx.ingress.kubernetes.io/rewrite-target: /$2
# spec:
#   ingressClassName: nginx
#   rules:
#   - host: monitoring.greenwatt.local
#     http:
#       paths:
#       # Grafana sur /grafana
#       - path: /grafana(/|$)(.*)
#         pathType: Prefix
#         backend:
#           service:
#             name: grafana-service
#             port:
#               number: 3000
#
#       # Prometheus sur /prometheus
#       - path: /prometheus(/|$)(.*)
#         pathType: Prefix
#         backend:
#           service:
#             name: prometheus-service
#             port:
#               number: 9090
#
# Accès :
# - http://monitoring.greenwatt.local/grafana
# - http://monitoring.greenwatt.local/prometheus

---
# ===========================================
# NOTES PÉDAGOGIQUES
# ===========================================
#
# 1. POURQUOI ClusterIP ?
#    - Grafana n'a pas besoin d'être exposé publiquement par défaut
#    - L'accès est contrôlé via Ingress avec TLS
#    - Plus sécurisé qu'un LoadBalancer ou NodePort
#
# 2. ACCÈS POUR LE DÉVELOPPEMENT :
#    - Port-forward : kubectl port-forward -n monitoring svc/grafana-service 3000:3000
#    - NodePort : Pour Minikube (facilite l'accès)
#    - Ingress : Production avec TLS
#
# 3. SÉCURITÉ :
#    - Changer le mot de passe admin après le premier login
#    - Activer TLS/HTTPS via Ingress
#    - Limiter les permissions des users
#    - Activer l'authentification OAuth2 en production
#
# 4. DASHBOARDS RECOMMANDÉS :
#    - GreenWatt Application (pré-configuré)
#    - Kubernetes Cluster Monitoring (ID 7249)
#    - Node Exporter Full (ID 1860)
#    - NGINX Ingress Controller (ID 9614)
#    - Redis Dashboard (ID 11835)
#    - PostgreSQL Database (ID 9628)
#
# 5. DATASOURCES SUPPLÉMENTAIRES :
#    - PostgreSQL : Requêtes directes sur la DB
#    - Redis : Monitoring Redis
#    - Loki : Logs aggregation
#    - Jaeger : Distributed tracing
#
# ===========================================
